<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>100 Joyaux</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.70.0/phaser.min.js"></script>
    <style>
        * { margin: 0; padding: 0; }
        body { 
            background: #000; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh;
            overflow: hidden;
        }
        #game-container { 
            max-width: 100vw; 
            max-height: 100vh; 
        }
        canvas { 
            display: block; 
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <script>
        class GameScene extends Phaser.Scene {
            constructor() {
                super('GameScene');
                this.gemsCollected = 0;
                this.coins = 0;
                this.skinCoins = 0;
            }

            preload() {
                // Charge les images depuis assets/images/
                this.load.image('bg', 'assets/images/background.png');
                this.load.spritesheet('player', 'assets/images/player.png', { 
                    frameWidth: 2048/9, 
                    frameHeight: 2048 
                });
                this.load.image('platform', 'assets/images/platform.png');
                this.load.image('gem', 'assets/images/gem.png');
                this.load.image('npc', 'assets/images/npc.png');
                this.load.image('coin', 'assets/images/coin.png');
                this.load.image('joystick-base', 'assets/images/joystick_base.png');
                this.load.image('joystick-stick', 'assets/images/joystick_stick.png');
                this.load.image('button-jump', 'assets/images/button_jump.png');
            }

            create() {
                const worldWidth = 2880;
                const worldHeight = 480;

                // Background
                this.add.tileSprite(0, 0, worldWidth, worldHeight, 'bg').setOrigin(0, 0);

                // Physics
                this.physics.world.bounds.width = worldWidth;
                this.physics.world.bounds.height = worldHeight;

                // Platforms
                this.platforms = this.physics.add.staticGroup();
                
                // Ground
                const ground = this.add.rectangle(worldWidth/2, 460, worldWidth, 40, 0x2a2a2a);
                this.physics.add.existing(ground, true);
                this.platforms.add(ground);

                // Plateformes aériennes
                const platformsData = [
                    {x: 300, y: 350, w: 150, h: 20},
                    {x: 550, y: 280, w: 120, h: 20},
                    {x: 800, y: 250, w: 180, h: 20},
                    {x: 1100, y: 300, w: 140, h: 20},
                    {x: 1350, y: 220, w: 160, h: 20},
                    {x: 1650, y: 280, w: 150, h: 20},
                    {x: 1950, y: 340, w: 130, h: 20},
                    {x: 2200, y: 260, w: 170, h: 20},
                    {x: 2500, y: 320, w: 200, h: 20}
                ];

                platformsData.forEach(p => {
                    const platform = this.add.rectangle(p.x, p.y, p.w, p.h, 0x8B4513);
                    this.physics.add.existing(platform, true);
                    this.platforms.add(platform);
                });

                // Player
                this.player = this.physics.add.sprite(100, 300, 'player');
                this.player.setCollideWorldBounds(true);
                this.player.setScale(0.3);
                this.player.body.setGravityY(800);

                // Animations
                this.anims.create({
                    key: 'idle',
                    frames: this.anims.generateFrameNumbers('player', { start: 0, end: 0 }),
                    frameRate: 10,
                    repeat: -1
                });

                this.anims.create({
                    key: 'walk',
                    frames: this.anims.generateFrameNumbers('player', { start: 0, end: 8 }),
                    frameRate: 10,
                    repeat: -1
                });

                // Gems
                this.gems = this.physics.add.group();
                for (let i = 0; i < 100; i++) {
                    const x = Phaser.Math.Between(90, 2700);
                    const y = Phaser.Math.Between(50, 350);
                    const gem = this.gems.create(x, y, 'gem');
                    gem.setScale(0.15);
                    gem.body.setAllowGravity(false);
                }

                // NPCs
                this.npcs = this.physics.add.staticGroup();
                const npcPositions = [500, 900, 1400, 1800, 2300];
                npcPositions.forEach(x => {
                    const npc = this.npcs.create(x, 380, 'npc');
                    npc.setScale(0.3);
                    npc.npcType = Math.random() > 0.5 ? 'gem' : 'shop';
                });

                // Collisions
                this.physics.add.collider(this.player, this.platforms);
                this.physics.add.overlap(this.player, this.gems, this.collectGem, null, this);
                this.physics.add.overlap(this.player, this.npcs, this.interactNPC, null, this);

                // Camera
                this.cameras.main.setBounds(0, 0, worldWidth, worldHeight);
                this.cameras.main.startFollow(this.player);

                // UI fixée
                this.uiText = this.add.text(16, 16, '', {
                    fontSize: '24px',
                    fill: '#fff',
                    backgroundColor: '#000',
                    padding: { x: 10, y: 5 }
                }).setScrollFactor(0).setDepth(100);

                this.updateUI();

                // Mobile controls
                this.createMobileControls();

                // Keyboard
                this.cursors = this.input.keyboard.createCursorKeys();
            }

            createMobileControls() {
                const width = this.cameras.main.width;
                const height = this.cameras.main.height;

                // Joystick
                this.joyBase = this.add.circle(100, height - 100, 50, 0x333333, 0.5)
                    .setScrollFactor(0).setDepth(100);
                this.joyStick = this.add.circle(100, height - 100, 30, 0x666666, 0.8)
                    .setScrollFactor(0).setDepth(101);

                this.joyStick.setInteractive();
                this.input.setDraggable(this.joyStick);

                this.joyActive = false;
                this.joyVector = { x: 0, y: 0 };

                this.input.on('dragstart', (pointer, gameObject) => {
                    if (gameObject === this.joyStick) {
                        this.joyActive = true;
                    }
                });

                this.input.on('drag', (pointer, gameObject, dragX, dragY) => {
                    if (gameObject === this.joyStick) {
                        const distance = Phaser.Math.Distance.Between(
                            this.joyBase.x, this.joyBase.y, dragX, dragY
                        );
                        const angle = Phaser.Math.Angle.Between(
                            this.joyBase.x, this.joyBase.y, dragX, dragY
                        );

                        if (distance < 50) {
                            this.joyStick.x = dragX;
                            this.joyStick.y = dragY;
                        } else {
                            this.joyStick.x = this.joyBase.x + Math.cos(angle) * 50;
                            this.joyStick.y = this.joyBase.y + Math.sin(angle) * 50;
                        }

                        this.joyVector.x = (this.joyStick.x - this.joyBase.x) / 50;
                        this.joyVector.y = (this.joyStick.y - this.joyBase.y) / 50;
                    }
                });

                this.input.on('dragend', (pointer, gameObject) => {
                    if (gameObject === this.joyStick) {
                        this.joyActive = false;
                        this.joyStick.x = this.joyBase.x;
                        this.joyStick.y = this.joyBase.y;
                        this.joyVector = { x: 0, y: 0 };
                    }
                });

                // Jump button
                this.jumpBtn = this.add.circle(width - 100, height - 100, 50, 0xff6666, 0.6)
                    .setScrollFactor(0).setDepth(100).setInteractive();
                
                this.add.text(width - 100, height - 100, 'JUMP', {
                    fontSize: '16px',
                    fill: '#fff'
                }).setOrigin(0.5).setScrollFactor(0).setDepth(101);

                this.jumpBtn.on('pointerdown', () => {
                    if (this.player.body.touching.down) {
                        this.player.setVelocityY(-500);
                    }
                });
            }

            collectGem(player, gem) {
                gem.destroy();
                this.gemsCollected++;
                this.updateUI();
            }

            interactNPC(player, npc) {
                // Simple interaction au contact
                if (!npc.interacted) {
                    npc.interacted = true;
                    if (npc.npcType === 'gem') {
                        this.gemsCollected++;
                    } else {
                        this.coins += 10;
                    }
                    this.updateUI();
                    setTimeout(() => npc.interacted = false, 2000);
                }
            }

            updateUI() {
                this.uiText.setText(`Joyaux: ${this.gemsCollected}/100 | Coins: ${this.coins}`);
            }

            update() {
                // Movement
                if (this.joyActive) {
                    this.player.setVelocityX(this.joyVector.x * 200);
                    
                    if (Math.abs(this.joyVector.x) > 0.1) {
                        this.player.anims.play('walk', true);
                        this.player.setFlipX(this.joyVector.x < 0);
                    } else {
                        this.player.anims.play('idle', true);
                    }
                } else if (this.cursors.left.isDown) {
                    this.player.setVelocityX(-200);
                    this.player.anims.play('walk', true);
                    this.player.setFlipX(true);
                } else if (this.cursors.right.isDown) {
                    this.player.setVelocityX(200);
                    this.player.anims.play('walk', true);
                    this.player.setFlipX(false);
                } else {
                    this.player.setVelocityX(0);
                    this.player.anims.play('idle', true);
                }

                // Jump keyboard
                if (Phaser.Input.Keyboard.JustDown(this.cursors.up) && this.player.body.touching.down) {
                    this.player.setVelocityY(-500);
                }
            }
        }

        const config = {
            type: Phaser.AUTO,
            width: 960,
            height: 480,
            parent: 'game-container',
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 },
                    debug: false
                }
            },
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.CENTER_BOTH
            },
            scene: GameScene,
            pixelArt: true
        };

        const game = new Phaser.Game(config);
    </script>
</body>
</html>
